<ion-header translucent class="ion-no-border">
  <ion-toolbar color="white">
    <ion-title>
      <ion-button id="site-trigger" fill="clear" color="dark" class="text-lg font-bold capitalize" style="--padding-start: 0; --padding-end: 0;">
        {{ currentSiteName }}
        <ion-icon slot="end" name="chevron-down-outline" size="small" class="ml-1 text-gray-400"></ion-icon>
      </ion-button>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">
        <ion-icon name="close-outline" color="dark" size="large"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="bg-[#f8f9fa]">

  <div class="sticky top-0 z-50 bg-[#f8f9fa]/95 backdrop-blur-sm px-4 py-3 space-y-3 shadow-sm border-b border-gray-100">
    <div class="flex gap-3">
      <button id="type-trigger" class="filter-btn flex-1">
        <ion-icon name="car-sport-outline" class="text-primary"></ion-icon>
        <span class="truncate font-medium">{{ selectedTypeText }}</span>
        <ion-icon name="chevron-down-outline" class="ml-auto text-gray-300 text-xs"></ion-icon>
      </button>
      <button id="interval-trigger" class="filter-btn w-1/3 justify-center">
        <ion-icon name="time-outline" class="text-gray-500"></ion-icon>
        <span class="font-medium">{{ slotInterval >= 60 ? (slotInterval/60) + ' ชม.' : slotInterval + ' น.' }}</span>
        <ion-icon name="chevron-down-outline" class="ml-2 text-gray-300 text-xs"></ion-icon>
      </button>
    </div>
    <div class="flex gap-3">
      <button id="floor-trigger" class="filter-btn flex-1">
        <ion-icon name="layers-outline" class="text-gray-500"></ion-icon>
        <div class="flex flex-col items-start overflow-hidden">
          <span class="text-[10px] text-gray-400 leading-none">ชั้น</span>
          <span class="truncate font-medium leading-tight">{{ selectedFloor === 'any' ? 'ชั้นไหนก็ได้' : selectedFloor }}</span>
        </div>
        <ion-icon name="chevron-down-outline" class="ml-auto text-gray-300 text-xs"></ion-icon>
      </button>
      <button id="zone-trigger" class="filter-btn flex-1">
        <ion-icon name="grid-outline" class="text-gray-500"></ion-icon>
        <div class="flex flex-col items-start overflow-hidden">
          <span class="text-[10px] text-gray-400 leading-none">โซน</span>
          <span class="truncate font-medium leading-tight">{{ selectedZone === 'any' ? 'โซนไหนก็ได้' : selectedZone }}</span>
        </div>
        <ion-icon name="chevron-down-outline" class="ml-auto text-gray-300 text-xs"></ion-icon>
      </button>
    </div>
  </div>

  <ion-popover trigger="site-trigger" id="site-popover" dismissOnSelect="true" class="menu-popover" side="bottom" alignment="center">
    <ng-template>
      <ion-list lines="full">
        <ion-list-header>เปลี่ยนสถานที่</ion-list-header>
        <ion-item *ngFor="let s of mockSites" button (click)="selectSite(s)" [class.selected-item]="currentSiteName === s.name">
          <ion-label class="ion-text-wrap">{{ s.name }}</ion-label>
          <ion-icon name="checkmark-circle" slot="end" color="primary" *ngIf="currentSiteName === s.name"></ion-icon>
        </ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>

  <ion-popover trigger="type-trigger" id="type-popover" dismissOnSelect="true" class="menu-popover">
    <ng-template>
      <ion-list lines="none">
        <ion-item button (click)="selectType('normal')" [class.selected-item]="selectedType === 'normal'"><ion-icon name="car-outline" slot="start"></ion-icon> รถทั่วไป</ion-item>
        <ion-item button (click)="selectType('ev')" [class.selected-item]="selectedType === 'ev'"><ion-icon name="flash-outline" slot="start"></ion-icon> รถ EV</ion-item>
        <ion-item button (click)="selectType('motorcycle')" [class.selected-item]="selectedType === 'motorcycle'"><ion-icon name="bicycle-outline" slot="start"></ion-icon> มอเตอร์ไซค์</ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>

  <ion-popover trigger="floor-trigger" id="floor-popover" dismissOnSelect="true" class="menu-popover">
    <ng-template>
      <ion-list lines="none">
        <ion-list-header>เลือกชั้น</ion-list-header>
        <ion-item button (click)="selectFloor('any')" [class.selected-item]="selectedFloor === 'any'">
          <ion-label>ชั้นไหนก็ได้ (ทั้งหมด)</ion-label>
          <ion-icon name="checkmark" slot="end" *ngIf="selectedFloor === 'any'" color="primary"></ion-icon>
        </ion-item>
        <ion-item *ngFor="let f of availableFloors" button (click)="selectFloor(f)" [class.selected-item]="selectedFloor === f">
          <ion-label>{{ f }}</ion-label>
          <ion-icon name="checkmark" slot="end" *ngIf="selectedFloor === f" color="primary"></ion-icon>
        </ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>

  <ion-popover trigger="zone-trigger" id="zone-popover" dismissOnSelect="true" class="menu-popover">
    <ng-template>
      <ion-list lines="none">
        <ion-list-header>เลือกโซน {{ selectedFloor !== 'any' ? '(' + selectedFloor + ')' : '' }}</ion-list-header>
        <ion-item button (click)="selectZone('any')" [class.selected-item]="selectedZone === 'any'">
          <ion-label>โซนไหนก็ได้ (ทั้งหมด)</ion-label>
          <ion-icon name="checkmark" slot="end" *ngIf="selectedZone === 'any'" color="primary"></ion-icon>
        </ion-item>
        <ion-item *ngFor="let z of availableZones" button (click)="selectZone(z)" [class.selected-item]="selectedZone === z">
          <ion-label>{{ z }}</ion-label>
          <ion-icon name="checkmark" slot="end" *ngIf="selectedZone === z" color="primary"></ion-icon>
        </ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>

  <ion-popover trigger="interval-trigger" id="interval-popover" dismissOnSelect="true" class="menu-popover">
    <ng-template>
      <ion-list lines="none">
        <ion-list-header>ความถี่ช่องจอด</ion-list-header>
        <ion-item button (click)="selectInterval(15)" [class.selected-item]="slotInterval === 15">15 นาที</ion-item>
        <ion-item button (click)="selectInterval(30)" [class.selected-item]="slotInterval === 30">30 นาที</ion-item>
        <ion-item button (click)="selectInterval(60)" [class.selected-item]="slotInterval === 60">1 ชั่วโมง</ion-item>
        <ion-item button (click)="selectInterval(240)" [class.selected-item]="slotInterval === 240">4 ชั่วโมง</ion-item>
      </ion-list>
    </ng-template>
  </ion-popover>


  <div class="p-4 pb-32 space-y-6">
    
    <div *ngFor="let day of displayDays" class="animate-fade-in pb-2">
      
      <div class="flex justify-between items-center px-1 pb-2 border-b border-gray-100">
    <div>
      <div class="flex items-baseline gap-2">
        <h2 class="text-xl font-bold text-gray-800">{{ day.dateLabel }}</h2>
        <span class="text-sm font-medium"
              [class.text-gray-500]="day.timeLabel !== 'ปิดบริการ'"
              [class.text-red-500]="day.timeLabel === 'ปิดบริการ'">
          ({{ day.timeLabel }})
        </span>
      </div>
    </div>

    <div class="flex items-center gap-1.5 bg-white px-3 py-1.5 rounded-lg border border-gray-200 shadow-sm"
         *ngIf="day.timeLabel !== 'ปิดบริการ'">
      <span class="text-xs text-gray-400">ว่าง</span>
      <span class="text-lg font-bold leading-none"
            [class.text-green-600]="day.available > 20"
            [class.text-yellow-600]="day.available <= 20 && day.available > 0"
            [class.text-red-600]="day.available === 0">
        {{ day.available }}
      </span>
      <span class="text-xs text-gray-400">/ {{ day.capacity }}</span>
    </div>
  </div>

      <div class="grid grid-cols-5 gap-2.5" *ngIf="day.slots.length > 0; else closedView">
        <button *ngFor="let slot of day.slots"
                class="slot-btn flex-col gap-0.5" 
                [disabled]="!slot.isAvailable"
                
                [class.unavailable]="!slot.isAvailable"
                [class.selected-start]="slot.isSelected && startSlot?.id === slot.id"
                [class.selected-end]="slot.isSelected && endSlot?.id === slot.id"
                [class.in-range]="slot.isInRange"
                
                (click)="onSlotClick(slot)">
          <div class="text-sm leading-none">{{ slot.timeText }}</div>
          <div class="text-[10px] font-normal opacity-70 leading-none" *ngIf="slot.isAvailable">
            ว่าง {{ slot.remaining }}
          </div>
        </button>
      </div>

      <ng-template #closedView>
        <div class="text-center py-6 bg-gray-50 rounded-xl border border-dashed border-gray-300">
          <ion-icon name="close-circle-outline" class="text-3xl text-gray-400 mb-1"></ion-icon>
          <div class="text-gray-500 text-sm">วันนี้ปิดบริการ</div>
        </div>
      </ng-template>

    </div>

  </div>

</ion-content>

<ion-footer class="ion-no-border">
  <div class="custom-footer">
    <div class="flex justify-between items-end mb-2"> <div *ngIf="startSlot">
        <div class="text-[10px] text-gray-400 font-medium mb-0.5">เวลาที่เลือก</div> <div class="text-base font-bold text-primary-600 leading-none flex items-center"> {{ startSlot.timeText }} 
          <ion-icon name="arrow-forward-outline" class="mx-1.5 text-gray-300 text-xs" *ngIf="endSlot"></ion-icon>
          <span *ngIf="endSlot">{{ endSlot.timeText }}</span>
        </div>
        <div class="text-[10px] text-gray-400 mt-0.5" *ngIf="startSlot">
          {{ startSlot.dateTime | date:'d MMM' }} 
          <span *ngIf="endSlot && startSlot.dateTime.getDate() !== endSlot.dateTime.getDate()">
             - {{ endSlot.dateTime | date:'d MMM' }}
          </span>
        </div>
      </div>
      
      <div class="text-right w-full" *ngIf="!startSlot">
        <div class="text-gray-400 text-xs text-center pt-1">แตะที่เวลาเพื่อเริ่มจอง</div>
      </div>
    </div>

    <ion-button expand="block" shape="round" 
                [disabled]="!startSlot || !endSlot" 
                (click)="confirmBooking()"
                class="confirm-btn font-bold text-base" style="--box-shadow: none;">
      ยืนยันการจอง
    </ion-button>
  </div>
</ion-footer>